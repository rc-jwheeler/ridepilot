:ruby
  if @runs.any?
    # basics
    ticks = get_availability_chart_ticks(15)

    max_hour = current_provider.driver_availability_max_hour || 22
    max_hour_label = format_hour_label(max_hour) 

    row_data = @runs.map{|r| {
      id: r.id,
      name: r.name,
      date: r.date,
      start_time_diff: (r.scheduled_start_time - r.scheduled_start_time.at_beginning_of_day) / 3600.0,
      end_time_diff: (r.scheduled_end_time - r.scheduled_end_time.at_beginning_of_day) / 3600.0,
      driver_id: r.driver_id,
      driver_name: r.driver.try(:user_name)
    }}
  end

:css
  .availability_forecast_run_view_panel .panel-heading{
    background-color: gray;
    border-color: gray;
  }

  .run-availability-table {
    margin-bottom: 0px;
    border-collapse: separate !important;
    border-spacing: 0 1em !important;
  }

  .run-availability-table tr.odd {
    background: transparent;
  }

  .run-availability-table td {
    border-top: none !important;
  }

  .run-availability-table td.disabled {
    color: lightgray;
  }

  .run-availability-table td {
    padding: 0px 5px !important;
  }

  .run-availability-table td.chart_cell.is_filled {
    background-color: #df96e2 !important;
  }

  .run-availability-table td.chart_cell.is_driver_filled {
    background-color: #be10c5 !important;
  }

  .hour_tick_label {
    display: inline-block;
    padding: 0px;
    margin: 0px 0px 0px -5px;
  }

  .run-availability-table a.link_disabled {
    pointer-events: none;
    cursor: default;
  }

  .run-availability-table a.link_disabled i {
    color: lightgrey !important;
  }


.panel.panel-primary.availability_forecast_run_view_panel
  .panel-heading
    .pull-right{style: 'padding-right: 0px;'}
      %span.panel-expand-collapse{title: 'Collapse/expand'}
        %i.fa.fa-chevron-up
    %b= "#{@runs.size} Runs: #{@total_assigned_run_count} Assigned, #{@total_unassigned_run_count} Unassigned"
  .panel-body.form-horizontal{style: 'padding:0px;'}
    .table-responsive{style: 'overflow: visible;'}
      - if @runs.any?
        %table.table.table-condensed.run-availability-table#run_availability_table
          %thead
            %th
            - tick_count = ticks.size
            %th{colspan: tick_count}
              %div{style: 'width: 100%; white-space:nowrap;'}
                - label_tick_count = ticks.select{|x| !x[1].blank?}.size
                - ticks.each_with_index do |tick, index|
                  - next if tick[1].blank?
                  %span.hour_tick_label{style: "width: #{100/label_tick_count.to_f}%;"}= tick[1]
                %span.hour_tick_label= max_hour_label
            
            - if can?(:edit, Run)
              %th

          %tbody
            - row_data.each do |r|
              %tr{data: {id: r[:id], driver_name: r[:driver_name], start_time: r[:start_time_diff], end_time: r[:end_time_diff]}}
                %td
                  = link_to r[:name], run_path(r[:id]), target: '_blank'
                - ticks.each do |tick|
                  - class_name = !(r[:start_time_diff] >= tick[0]) && !(r[:end_time_diff] <= tick[0]) ? "is_filled" : ""
                  - class_name = 'is_driver_filled' if !class_name.blank? && !r[:driver_id].blank?
                  %td.chart_cell{style: "white-space: nowrap !important; color: white;", class: class_name || "", data: {time_flag: tick[0]}}
                - if can?(:edit, Run)
                  %td.pull-right
                    = link_to unassign_driver_run_path(r[:id]), method: 'patch', remote: true, class: r[:driver_id].blank? ? "link_disabled" : "",  data: {confirm: 'Are you sure to unassign the driver from this run?'} do 
                      %i.fa.fa-remove{style: 'color: red;'}
                    .dropdown{style: 'display: inline-block !important;'}
                      %button{type: 'button', data: {toggle: 'dropdown'}}
                        Assign
                        %span.caret
                      %ul.dropdown-menu.pull-right
                        - @drivers_available_for_runs[r[:id]].each do |d|
                          %li
                            %a{href:'#', data: {driver_id: d[:id]}}
                              = d[:name]

 
- if @runs.any?
  :javascript
    $(function() {
      // fixed table header
      $('#run_availability_table').floatThead({
        scrollContainer: function($table){
          return $table.closest('.table-responsive');
        }
      });

      setTimeout(function() {
        $('#run_availability_table tr').each(function() {
          $(this).find('td.is_driver_filled:first').text($(this).data('driver-name'));
        });
      }, 200);
    });